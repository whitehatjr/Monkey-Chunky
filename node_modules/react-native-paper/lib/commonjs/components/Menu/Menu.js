var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _objectSpread2=_interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf3=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var React=_interopRequireWildcard(require("react"));var _reactNative=require("react-native");var _theming=require("../../core/theming");var _Portal=_interopRequireDefault(require("../Portal/Portal"));var _Surface=_interopRequireDefault(require("../Surface"));var _MenuItem2=_interopRequireDefault(require("./MenuItem"));var _constants=require("../../constants");var _jsxFileName="/Users/satya/Workspace/Callstack/react-native-paper/src/components/Menu/Menu.tsx";var SCREEN_INDENT=8;var ANIMATION_DURATION=250;var EASING=_reactNative.Easing.bezier(0.4,0,0.2,1);var Menu=function(_React$Component){(0,_inherits2.default)(Menu,_React$Component);function Menu(){var _getPrototypeOf2;var _this;(0,_classCallCheck2.default)(this,Menu);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=(0,_possibleConstructorReturn2.default)(this,(_getPrototypeOf2=(0,_getPrototypeOf3.default)(Menu)).call.apply(_getPrototypeOf2,[this].concat(args)));_this.state={rendered:_this.props.visible,top:0,left:0,menuLayout:{width:0,height:0},anchorLayout:{width:0,height:0},opacityAnimation:new _reactNative.Animated.Value(0),scaleAnimation:new _reactNative.Animated.ValueXY({x:0,y:0})};_this.anchor=null;_this.menu=null;_this.isAnchorCoord=function(){return!React.isValidElement(_this.props.anchor);};_this.measureMenuLayout=function(){return new Promise(function(resolve){if(_this.menu){_this.menu.measureInWindow(function(x,y,width,height){resolve({x:x,y:y,width:width,height:height});});}});};_this.measureAnchorLayout=function(){return new Promise(function(resolve){var anchor=_this.props.anchor;if(_this.isAnchorCoord()){resolve({x:anchor.x,y:anchor.y,width:0,height:0});return;}if(_this.anchor){_this.anchor.measureInWindow(function(x,y,width,height){resolve({x:x,y:y,width:width,height:height});});}});};_this.updateVisibility=function _callee(){return _regenerator.default.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return _regenerator.default.awrap(Promise.resolve());case 2:if(_this.props.visible){_this.show();}else{_this.hide();}case 3:case"end":return _context.stop();}}});};_this.isBrowser=function(){return _reactNative.Platform.OS==='web'&&'document'in global;};_this.focusFirstDOMNode=function(el){if(el&&_this.isBrowser()){var node=(0,_reactNative.findNodeHandle)(el);var focusableNode=node.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');focusableNode&&focusableNode.focus();}};_this.handleDismiss=function(){if(_this.props.visible){_this.props.onDismiss();}return true;};_this.handleKeypress=function(e){if(e.key==='Escape'){_this.props.onDismiss();}};_this.attachListeners=function(){_reactNative.BackHandler.addEventListener('hardwareBackPress',_this.handleDismiss);_reactNative.Dimensions.addEventListener('change',_this.handleDismiss);_this.isBrowser()&&document.addEventListener('keyup',_this.handleKeypress);};_this.removeListeners=function(){_reactNative.BackHandler.removeEventListener('hardwareBackPress',_this.handleDismiss);_reactNative.Dimensions.removeEventListener('change',_this.handleDismiss);_this.isBrowser()&&document.removeEventListener('keyup',_this.handleKeypress);};_this.show=function _callee2(){var windowLayout,_ref,_ref2,menuLayout,anchorLayout;return _regenerator.default.async(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:windowLayout=_reactNative.Dimensions.get('window');_context2.next=3;return _regenerator.default.awrap(Promise.all([_this.measureMenuLayout(),_this.measureAnchorLayout()]));case 3:_ref=_context2.sent;_ref2=(0,_slicedToArray2.default)(_ref,2);menuLayout=_ref2[0];anchorLayout=_ref2[1];if(!(!windowLayout.width||!windowLayout.height||!menuLayout.width||!menuLayout.height||!anchorLayout.width&&!_this.isAnchorCoord()||!anchorLayout.height&&!_this.isAnchorCoord())){_context2.next=10;break;}requestAnimationFrame(_this.show);return _context2.abrupt("return");case 10:_this.setState(function(){return{left:anchorLayout.x,top:anchorLayout.y,anchorLayout:{height:anchorLayout.height,width:anchorLayout.width},menuLayout:{width:menuLayout.width,height:menuLayout.height}};},function(){_this.attachListeners();var animation=_this.props.theme.animation;_reactNative.Animated.parallel([_reactNative.Animated.timing(_this.state.scaleAnimation,{toValue:{x:menuLayout.width,y:menuLayout.height},duration:ANIMATION_DURATION*animation.scale,easing:EASING,useNativeDriver:true}),_reactNative.Animated.timing(_this.state.opacityAnimation,{toValue:1,duration:ANIMATION_DURATION*animation.scale,easing:EASING,useNativeDriver:true})]).start(function(_ref3){var finished=_ref3.finished;if(finished){_this.focusFirstDOMNode(_this.menu);}});});case 11:case"end":return _context2.stop();}}});};_this.hide=function(){_this.removeListeners();var animation=_this.props.theme.animation;_reactNative.Animated.timing(_this.state.opacityAnimation,{toValue:0,duration:ANIMATION_DURATION*animation.scale,easing:EASING,useNativeDriver:true}).start(function(finished){if(finished){_this.setState({menuLayout:{width:0,height:0}});_this.state.scaleAnimation.setValue({x:0,y:0});_this.focusFirstDOMNode(_this.anchor);_this.setState({rendered:false});}});};return _this;}(0,_createClass2.default)(Menu,[{key:"componentDidUpdate",value:function componentDidUpdate(prevProps){if(prevProps.visible!==this.props.visible){this.updateVisibility();}}},{key:"componentWillUnmount",value:function componentWillUnmount(){this.removeListeners();}},{key:"render",value:function render(){var _this2=this;var _this$props=this.props,visible=_this$props.visible,anchor=_this$props.anchor,contentStyle=_this$props.contentStyle,style=_this$props.style,children=_this$props.children,theme=_this$props.theme,statusBarHeight=_this$props.statusBarHeight,onDismiss=_this$props.onDismiss;var _this$state=this.state,rendered=_this$state.rendered,menuLayout=_this$state.menuLayout,anchorLayout=_this$state.anchorLayout,opacityAnimation=_this$state.opacityAnimation,scaleAnimation=_this$state.scaleAnimation;var _this$state2=this.state,left=_this$state2.left,top=_this$state2.top;var additionalVerticalValue=_reactNative.Platform.select({android:statusBarHeight,default:0});var scaleTransforms=[{scaleX:scaleAnimation.x.interpolate({inputRange:[0,menuLayout.width],outputRange:[0,1]})},{scaleY:scaleAnimation.y.interpolate({inputRange:[0,menuLayout.height],outputRange:[0,1]})}];var windowLayout=_reactNative.Dimensions.get('window');var positionTransforms=[];if(left<=windowLayout.width-menuLayout.width-SCREEN_INDENT){positionTransforms.push({translateX:scaleAnimation.x.interpolate({inputRange:[0,menuLayout.width],outputRange:[-(menuLayout.width/2),0]})});if(left<SCREEN_INDENT){left=SCREEN_INDENT;}}else{positionTransforms.push({translateX:scaleAnimation.x.interpolate({inputRange:[0,menuLayout.width],outputRange:[menuLayout.width/2,0]})});left+=anchorLayout.width-menuLayout.width;var right=left+menuLayout.width;if(right>windowLayout.width-SCREEN_INDENT){left=windowLayout.width-SCREEN_INDENT-menuLayout.width;}}var scrollableMenuHeight=0;if(top>=windowLayout.height-menuLayout.height-SCREEN_INDENT-additionalVerticalValue&&top<=windowLayout.height-top){scrollableMenuHeight=windowLayout.height-top-SCREEN_INDENT-additionalVerticalValue;}else if(top>=windowLayout.height-menuLayout.height-SCREEN_INDENT-additionalVerticalValue&&top>=windowLayout.height-top&&top<=menuLayout.height-anchorLayout.height+SCREEN_INDENT-additionalVerticalValue){scrollableMenuHeight=top+anchorLayout.height-SCREEN_INDENT+additionalVerticalValue;}scrollableMenuHeight=scrollableMenuHeight>windowLayout.height-2*SCREEN_INDENT?windowLayout.height-2*SCREEN_INDENT:scrollableMenuHeight;if(top<=windowLayout.height-menuLayout.height-SCREEN_INDENT-additionalVerticalValue||top>=windowLayout.height-menuLayout.height-SCREEN_INDENT-additionalVerticalValue&&top<=windowLayout.height-top){positionTransforms.push({translateY:scaleAnimation.y.interpolate({inputRange:[0,menuLayout.height],outputRange:[-((scrollableMenuHeight||menuLayout.height)/2),0]})});if(top<SCREEN_INDENT){top=SCREEN_INDENT;}}else{positionTransforms.push({translateY:scaleAnimation.y.interpolate({inputRange:[0,menuLayout.height],outputRange:[(scrollableMenuHeight||menuLayout.height)/2,0]})});top+=anchorLayout.height-(scrollableMenuHeight||menuLayout.height);var bottom=top+(scrollableMenuHeight||menuLayout.height)+additionalVerticalValue;if(bottom>windowLayout.height-SCREEN_INDENT){top=scrollableMenuHeight===windowLayout.height-2*SCREEN_INDENT?-SCREEN_INDENT*2:windowLayout.height-menuLayout.height-SCREEN_INDENT-additionalVerticalValue;}}var shadowMenuContainerStyle=(0,_objectSpread2.default)({opacity:opacityAnimation,transform:scaleTransforms,borderRadius:theme.roundness},scrollableMenuHeight?{height:scrollableMenuHeight}:{});var positionStyle=(0,_objectSpread2.default)({top:this.isAnchorCoord()?top:top+additionalVerticalValue},_reactNative.I18nManager.isRTL?{right:left}:{left:left});return React.createElement(_reactNative.View,{ref:function ref(_ref5){_this2.anchor=_ref5;},collapsable:false,__source:{fileName:_jsxFileName,lineNumber:530}},this.isAnchorCoord()?null:anchor,rendered?React.createElement(_Portal.default,{__source:{fileName:_jsxFileName,lineNumber:538}},React.createElement(_reactNative.TouchableWithoutFeedback,{onPress:onDismiss,__source:{fileName:_jsxFileName,lineNumber:539}},React.createElement(_reactNative.View,{style:_reactNative.StyleSheet.absoluteFill,__source:{fileName:_jsxFileName,lineNumber:540}})),React.createElement(_reactNative.View,{ref:function ref(_ref4){_this2.menu=_ref4;},collapsable:false,accessibilityViewIsModal:visible,style:[styles.wrapper,positionStyle,style],pointerEvents:visible?'box-none':'none',__source:{fileName:_jsxFileName,lineNumber:542}},React.createElement(_reactNative.Animated.View,{style:{transform:positionTransforms},__source:{fileName:_jsxFileName,lineNumber:551}},React.createElement(_Surface.default,{style:[styles.shadowMenuContainer,shadowMenuContainerStyle,contentStyle],__source:{fileName:_jsxFileName,lineNumber:552}},scrollableMenuHeight&&React.createElement(_reactNative.ScrollView,{__source:{fileName:_jsxFileName,lineNumber:562}},children)||React.createElement(React.Fragment,{__source:{fileName:_jsxFileName,lineNumber:563}},children))))):null);}}],[{key:"getDerivedStateFromProps",value:function getDerivedStateFromProps(nextProps,prevState){if(nextProps.visible&&!prevState.rendered){return{rendered:true};}return null;}}]);return Menu;}(React.Component);Menu.Item=_MenuItem2.default;Menu.defaultProps={statusBarHeight:_constants.APPROX_STATUSBAR_HEIGHT};var styles=_reactNative.StyleSheet.create({wrapper:{position:'absolute'},shadowMenuContainer:{opacity:0,paddingVertical:8,elevation:8}});var _default=(0,_theming.withTheme)(Menu);exports.default=_default;
//# sourceMappingURL=Menu.js.map